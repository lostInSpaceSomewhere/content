commonfields:
  id: QRadarGetOffenseCorrelationsResult
  version: -1
name: QRadarGetOffenseCorrelationsResult
script: |-
  d_args = demisto.args()
  offense_id = demisto.get(d_args, 'offenseID')

  resp = demisto.executeCommand('qradar-get-search-results',d_args)
  if isError(resp[0]):
      demisto.results(resp)
  else:
      data = demisto.get(resp[0],'Contents')

      if data == u'There is no output result':
          resp[0]['HumanReadable'] = "No Correlations were found for offense id {0}".format(offense_id)
      else:
          data = data if isinstance(data,list) else [data]

          QRadar = {}
          QRadar['QRadar.Correlation'] = []

          for corr in data:
              keys = corr.keys()
              correlation = {}
              #Standardized known keys
              correlation["SourceIP"] = demisto.get(corr,"sourceip")
              keys.remove("sourceip") if "sourceip" in keys else None

              correlation["CREDescription"] = demisto.get(corr,"CRE Description")
              keys.remove("CRE Description") if "CRE Description" in keys else ""

              correlation["CREName"] = demisto.get(corr,"CRE Name")
              keys.remove("CRE Name") if "CRE Name" in keys else ""

              correlation["QID"] = demisto.get(corr,"qid")
              keys.remove("qid") if "qid" in keys else ""

              correlation["DestinationIP"] = demisto.get(corr,"destinationip")
              keys.remove("destinationip") if "destinationip" in keys else ""

              correlation["Category"] = demisto.get(corr,"categoryname_highlevelcategory")
              keys.remove("categoryname_highlevelcategory") if "categoryname_highlevelcategory" in keys else ""

              correlation["CategoryID"] = demisto.get(corr,"category")
              keys.remove("category") if "category" in keys else ""

              correlation["Username"] = demisto.get(corr,"username")
              keys.remove("username") if "username" in keys else ""

              correlation["StartTime"] = demisto.get(corr,"starttime")
              keys.remove("starttime") if "starttime" in keys else ""

              #Push to context rest of the keys (won't be shown in 'outputs')
              for key in keys:
                  correlation[''.join(x for x in key.title() if not x.isspace())] = demisto.get(corr,key)

              QRadar['QRadar.Correlation'].append(correlation)

          resp[0]['EntryContext'] = QRadar

  demisto.results(resp)
type: python
tags:
- QRadar
comment: Return the QRadar offense correlations results if exist in logs.
enabled: true
args:
- name: offenseID
  required: true
  default: true
  description: The offense ID to query.
  defaultValue: ${incident.labels.id}
- name: headers
  description: Table headers
- name: range
  description: Number of results in return
- name: search_id
  required: true
  description: Offense correlations search id.
outputs:
- contextPath: QRadar.Correlation
  description: The QRadar offense correlations
- contextPath: QRadar.Correlation.QID
  description: The correlation QID identifier
- contextPath: QRadar.Correlation.CREName
  description: The correlation name
- contextPath: QRadar.Correlation.CREDescription
  description: The correlation description
- contextPath: QRadar.Correlation.SourceIP
  description: The correlation source IP
- contextPath: QRadar.Correlation.DestinationIP
  description: The correlation destination IP
- contextPath: QRadar.Correlation.Category
  description: The correlation high level category
- contextPath: QRadar.Correlation.Username
  description: The correlation username
- contextPath: QRadar.Correlation.StartTime
  description: The correlation start time
- contextPath: QRadar.Correlation.CategoryID
  description: 'The correlation category id '
- contextPath: QRadar
  description: QRadar context output
scripttarget: 0
dependson:
  must:
  - qradar-searches
runonce: false
releaseNotes: "-"
tests:
  - Forgive me for my sins but I did not create any test
