commonfields:
  id: Symantec Deepsight Intelligence
  version: -1
name: Symantec Deepsight Intelligence
display: Symantec Deepsight Intelligence
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Leverage Symantec Deepsight Intelligence
configuration:
- display: API Key
  name: apikey
  defaultvalue: ""
  type: 4
  required: true
- display: https://deepsightapi.symantec.com
  name: url
  defaultvalue: https://deepsightapi.symantec.com
  type: 0
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: unsecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    import requests
    import json

    # This Integration currently does not include MATI based resources

    ''' Global Variables '''
    APIKEY = demisto.params()['apikey']
    VERIFY = not demisto.params()['unsecure']
    BASE_URL = demisto.params()['url']
    BASE_URL += 'v1' if BASE_URL[-1] == '/' else '/v1'
    DOMAIN_URL = BASE_URL + '/domains/'
    IP_URL = BASE_URL + '/ips/'
    URL_URL = BASE_URL + '/urls/'
    FILE_URL = BASE_URL + '/files/'
    USAGE_URL = BASE_URL + '/application/usage_limit_status/'
    DBOTSCOREKEY = 'DBotScore'

    if not demisto.getParam('proxy'):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']


    headers = {'API-KEY': APIKEY, 'Accept': 'application/json'}


    # Define return code values based on the symantec deepsight api documentation.
    def return_code_match(statusCode):
        if statusCode == 200:
            return "200: Success"
        if statusCode == 400:
            return "400: Invalid Input. Input was incorrect format."
        if statusCode == 403:
            return "403: Access Denied. API key successful, but license does not permit access to the requested resource."
        if statusCode == 404:
            return "404: Data not found"
        if statusCode == 429:
            return "429: License count usage has been exceeded."
        return "503: Server is overloaded.  Try again later"

    #Output Headers / Contextkeys
    DOMAIN_REPORT_HEADERS = {}
    IP_REPORT_HEADERS = {}
    URL_REPORT_HEADERS = {}
    FILE_REPORT_HEADERS= {}

    ''' Functions '''
    # Build Markdown contextual data for human readable data in war room output
    def build_md(jsondata, searchItem):
        mdOutput = "## Symantec Deepsight Intelligence: " + str(searchItem).upper()
        for key in jsondata.keys():
            if isinstance(jsondata[key],dict):
                mdOutput += "\n\n__" + key.upper() + "__"
                for k in jsondata[key]:
                    if str(k) != 'uri':
                        mdOutput += "\n- __" + (str(k)).upper() + "__: " + str(jsondata[key][k])
            elif isinstance(jsondata[key], list):
                mdOutput += "\n\n__" + key.upper() + "__"
                for i in range(len(jsondata[key])):
                    if isinstance(jsondata[key][i], dict):
                        for x in jsondata[key][i]:
                            if str(x) != 'uri':
                                mdOutput += "\n- __" + (str(x)).upper() + "__: " + str(jsondata[key][i][x])
                    else:
                        mdOutput += "\n- __" + (str(i)).upper() + "__: " + str(jsondata[key][i])
            else:
                mdOutput += "\n\n__" + key.upper() + "__: " + str(jsondata[key])
        return mdOutput

    def getHashType(h):
        size = len(h)
        if size == 64:
            return 'SHA256'
        elif size == 32:
            return 'MD5'

    ## =====  Validate Connectivity =============
    # get results of request status - determine current limit usage of the api license
    def request_status():
        req_status = requests.get(USAGE_URL, headers=headers, verify=VERIFY)
        json_req_status = json.loads(req_status.content)
        md = build_md(json_req_status, "Request Status")
        return {
            'Type' : entryTypes['note'],
            'Contents' : json_req_status,
            'ContentsFormat' : formats['json'],
            'ReadableContentsFormat' : formats['markdown'],
            'HumanReadable' : md,
            'EntryContext' : json_req_status
        }

    ## =====  Domain Intel =============
    # get information for a given Domain.
    # reputation 1-10, confidenc 1-5, hostility 1-5
    def request_domain_intel():
        domain = demisto.args()['domain']
        dom_req = requests.get(DOMAIN_URL + domain, headers=headers, verify=VERIFY)
        json_req_domain = json.loads(dom_req.content)

        # BUILD MARKDOWN FOR WARROOM OUTPUT
        md = build_md(json_req_domain, domain)

        ec = {}
        ec['DBotScore'] = []
        domain_ec = {'Domain': domain, 'SymantecDeepsight':{}}

        # SET INITIAL DBOTSCORE VALUE
        dbotscore = 0

        # DETERMINE DBOTSCORE BASED ON THE EXISTENCE OF A REPUATION AND
        #  WHAT THAT VALUE IS.
        #  ADJUST THE THRESHOLD AS REQUIRED
        dom_rep_data = json_req_domain.get('reputationValues', None) if json_req_domain.get('reputationValues',None) else None
        if dom_rep_data is not None:
            dom_rep = json_req_domain['reputationValues']['reputation']
            #domain_ec.update({outputPaths['domain']['SymantecDeepsight']:{'Reputation': dom_rep}})
            if dom_rep > 5:
                dbotscore = 3
            else:
                dbotscore = 2

        # SET EC'S DBOTSCORE
        ec['DBotScore'] =  {'Indicator' : domain,'Score' : dbotscore,'Type' : 'domain','Vendor' : 'Symantec Deepsight Intelligence'}

        # GET ASSOCIATED IPS
        associated_ips = []
        ips = json_req_domain.get('ips', None) if json_req_domain.get('ips', None) else None
        if ips is not None:
            for address in ips:
                associated_ips.append(address['ip'])
            domain_ec.udpate({outputPaths['domain']['SymantecDeepsight']:{'AssociatedIPs': associated_ips}})
        associated_urls = []

        # GET ASSOCIATED URLS
        urls = json_req_domain.get('urls', None) if json_req_domain.get('urls', None) else None
        if urls is not None:
            for url in urls:
                associated_urls.append(url['url'])
            domain_ec['SymantecDeepsight'].update({'AssociatedURLs': associated_urls})

        # GET ASSOCIATED BEHAVIOURS
        associated_behaviours = []
        behaviours = json_req_domain.get('behaviours', None) if json_req_domain.get('behaviours', None) else None
        if behaviours is not None:
            for b in behaviours:
                associated_behaviours.append(b)

        # BUILD CONTEXTUAL OUTPUTS FOR THE DOMAIN TO RETURN TO DEMISTO
        if dbotscore == 3:
            # domain is malicious
            ec.update({outputPaths['Domain']: {
                    'Name': domain,
                    'Malicious':{
                        'Description': "Reputation is " + str(dom_rep_data['reputation']) + " out of 10",
                        'Vendor': "Symantec Deepsight Intelligence",
                        'Behaviours': associated_behaviours
                    }
                }
            })
        else:
            ec.update({outputPaths['Domain']:{
                    'Name': domain
                }
            })

        if ec.get(outputPaths['Domain'], False):
            ec[outputPaths['Domain']['SymantecDeepsight']] = {}
            ec[outputPaths['Domain']['SymantecDeepsight']].update({'WhoIs': json_req_domain['whois']})
            if len(associated_urls) >= 1:
                ec[outputPaths['Domain']['SymantecDeepsight']].update({'AssociatedURLs': associated_urls})
            if len(associated_ips) >= 1:
                ec[outputPaths['Domain']['SymantecDeepsight']].update({'AssociatedIPs': associated_ips})
        else:
            ec['Domain'].update(domain_ec)
        return {
            'Type' : entryTypes['note'],
            'Contents' : json_req_domain,
            'ContentsFormat' : formats['json'],
            'HumanReadable' : md, # not sure if need to build the md first?
            'ReadableContentsFormat' : formats['markdown'],
            'EntryContext' : ec
        }

    ## =====  IP Intel =============
    # Return data base on IP search
    # reputation Values if exist are 1-10, 10 being worst
    def request_ip_intel():
        # Build out variables to collect data
        ip = demisto.args()['ip']
        ec={}
        ec['DBotScore'] = []
        dbotscore = 0
        demonstrated_behaviours = []
        demonstrated_behaviour_description = []


        # Query API endpoint and return results
        req_ip = requests.get(IP_URL + ip, headers=headers, verify=VERIFY)
        json_req_ip = json.loads(req_ip.content)
        md = build_md(json_req_ip, ip)

        whitelist = json_req_ip.get('whitelisted', None) if json_req_ip.get('whitelisted', None) else None
        asn = json_req_ip['network']['asn']
        carrier = json_req_ip['network']['carrier']


        # Evalutating Risk of IP address
        # If the 'behaviours' is returned then there is a risk.
        # evalute if the behaviour is Spam, if so set the dbotscore to 2 (suspicious)
        # else set dbotscore to 3 (malicious)
        # - also are assigning the 'behaviour' values to a list to be added to ['Malicious'] content key description
        if 'behaviours' in json_req_ip.keys():
            behaviours_ip = json_req_ip['behaviours']
            if len(behaviours_ip) == 1:
                if behaviours_ip[0]['behaviour'] == 'Spam':
                    dbotscore = 2
                else:
                    dbotscore = 3
                demonstrated_behaviours.append(behaviours_ip[0]['behaviour'])
                demonstrated_behaviour_description.append(behaviours_ip[0]['description'])
            else:
                behaviour_risk = 0
                for b in behaviours_ip:
                    if b['behaviour'] == 'Spam':
                        behaviour_risk = 2
                        if behaviour_risk > dbotscore:
                            dbotscore = behaviour_risk
                    else:
                        dbotscore = 3
                    demonstrated_behaviours.append(b['behaviour'])
                    demonstrated_behaviour_description.append(b['description'])

        # should define these values prior - to ensure those that do not exist have None values.
        ip_ec = {
            'Address': ip,
            'SymantecDeepsight': {
            }
        }

        # Collect URL information
        urls = []
        incUrls = json_req_ip.get('urls', None) if json_req_ip.get('urls', None) else None
        if incUrls is not None:
            for url in incUrls:
                    urls.append(url['url'])
            ip_ec.update({
                outputPaths['ip']['SymantecDeepsight']:{
                    'AssociatedURLs': urls
                }
            })

        # Collect Domain Information
        domains = []
        incDomains = json_req_ip.get('domains', None) if json_req_ip.get('domains', None) else None
        if incDomains is not None:
            for d in incDomains:
                domains.append(d['domain'])
            ip_ec.update({
                outputPaths['ip']['SymantecDeepsight']:{
                    'AssociatedDomains': domains
                }
            })

        # collect target country
        tcs = []
        targCountries = json_req_ip.get('targetCountries', None) if json_req_ip.get('targetCountries', None) else None
        if targCountries is not None:
            tcs.append(json_req_ips['targetCountries'])
            ip_ec.update({
                outputPaths['ip']['SymantecDeepsight']:{
                    'TargetCountries': tcs
                }
            })
        # collect target industry
        tgvectors = []
        tVectors = json_req_ip.get('targetIndustries', None) if json_req_ip.get('targetIndustries', None) else None
        if tVectors is not None:
            for vector in json_req_ip['targetIndustries']:
                tgvectors.append(vector['name'])
            ip_ec.update({
                outputPaths['ip']['SymantecDeepsight']:{
                    'TargetVectors': tgvectors
                }
            })


        # Building the entry context
        # If dbotscore is 3 (Malicious), context key .Maliciious needs to be included
        if dbotscore == 3:
            ec.update({
                outputPaths['ip']: {
                    'Address': ip,
                    'ASN': asn,
                    'Carrier': carrier,
                    'Geo': {
                        'Country': json_req_ip['geolocation']['country']
                    },
                    'Malicious': {
                        'Description': 'Risk behaviour(s): ' + ",".join(demonstrated_behaviours),
                        'Vendor': 'Symantec Deepsight Intelligence'
                        # Want to add the behaviors, targetted countries and industries here
                    }
                }
            })
        else:
            ec.update({
                outputPaths['ip']: {
                    'Address': ip,
                    'ASN': asn,
                    'Carrier': carrier,
                    'Geo': {
                        'Country': json_req_ip['geolocation']['country']
                    }
                }
            })

        ec['DBotScore'] = {
            'Indicator' : ip,
            'Score' : dbotscore,
            'Type' : 'ip',
            'Vendor' : 'Symantec Deepsight Intelligence'
        }

        if (ec.get(outputPaths['ip'], False)):
            ec[outputPaths['ip']]['SymantecDeepsight'] = {
            }
            # Add data to the above if it exists
            if urls is not None:
                ec[outputPaths['ip']['SymantecDeepsight']].update({'AssociatedURLs':urls})
            if domains is not None:
                ec[outputPaths['ip']['SymantecDeepsight']].update({'AssociatedDomains':domains})
            if tcs is not None:
                ec[outputPaths['ip']['SymantecDeepsight']].update({'TargetCountries':tcs})
            if tgvectors is not None:
                ec[outputPaths['ip']['SymantecDeepsight']].update({'TargetVectors':tgvectors})
        else:
            ec[outputPaths['ip']].update(ip_ec)
        return {
            'Type' : entryTypes['note'],
            'Contents' : json_req_ip,
            'ContentsFormat' : formats['json'],
            'HumanReadable' : md, # not sure if need to build the md first?
            'ReadableContentsFormat' : formats['markdown'],
            'EntryContext' : ec
        }

    ### ====== FILE (hash) Intel ============
    # Return data based on a sha256 or md5 hash search
    def request_file_intel():
        filehash = demisto.args()['hash']
        req_filehash = requests.get(FILE_URL + filehash, headers=headers, verify=VERIFY)
        json_filehash = json.loads(req_filehash.content)
        md = tableToMarkdown(filehash, json_filehash, headers=None, headerTransform=None, removeNull=False, metadata=None)
        dbotscore = 0
        ec={}
        ec['DBotScore'] = []
        file_ec = {}

        hashType = getHashType(filehash)

        if req_filehash.status_code == 200:

            if hashType == 'SHA256':
                file_ec['File'] = {'SHA256': filehash}
            else:
                file_ec['File'] = {'MD5': filehash}

            # DETERMINE REPUTATION OF FILE AND SET DBOTSCORE ACCORDINGLY
            fileReputation = json_filehash.get('reputation', None) if json_filehash.get('reputation', None) else None
            if fileReputation is not None:
                file_ec['SymantecDeepsight'] = {'Reputation': fileReputation}
                if fileReputation == 'Malicious':
                    dbotscore = 3
                elif fileReputation == 'Trending Bad':
                    dbotscore = 2
                elif fileReputation == 'Good' or fileReputation == 'Trending Good':
                    dbotscore = 1

            md5Hash = json_filehash.get('MD5', None) if json_filehash.get('MD5', None) else None
            sha256Hash = json_filehash.get('SHA256', None) if json_filehash.get('SHA256', None) else None
            detectionName = json_filehash.get('detectionName', None) if json_filehash.get('detectionName', None) else None

            if dbotscore == 3:
                ec.update({
                    outputPaths['file']:{
                        'MD5': md5Hash,
                        'SHA256': sha256Hash
                    },
                    'Mailicious':{
                        'Description': filehash + ' reputation is ' + fileReputation,
                        'Vendor': 'Symantec Deepsight Intelligence'
                    }
                })
            else:
                if hashType == 'SHA256':
                    ec.udpate({outputPaths['file']:{'SHA256': filehash}})
                else:
                    ec.update({outputPaths['file']:{'MD5': filehash}})

            ec['DBotScore'] = {'Indicator': filehash, 'Score': dbotscore, 'Type': 'hash', 'Vendor': 'Symantec Deepsight Intelligence'}

            if ec.get(outputPaths['file'], False):
                ec[outputPaths['file']['SymantecDeepsight']] = {}
                ec[outputPaths['file']['SymantecDeepsight']].update({'Reputation': fileReputation, 'DetectionName': detectionName})
            else:
                ec[outputPaths['file']].update(file_ec)

            return {
                'Type' : entryTypes['note'],
                'Contents' : json_filehash,
                'ContentsFormat' : formats['json'],
                'HumanReadable' : md, # not sure if need to build the md first?
                'ReadableContentsFormat' : formats['markdown'],
                'EntryContext' : ec
            }
        else:
            return md


    ## =====  URL Intel =============
    # Search for intel based on an URL
    # if behaviour has value other than SPAM => malicous (possible values are Attack, Bot, CnC, Fraud, Malware, Phish_host or SPAM)
    #  else if behaviour is SPAM => suspicious
    #  if no behaviour, then unknown
    def request_url_intel():
        url = demisto.args()['url']
        req_url = requests.get(URL_URL + url, headers=headers, verify=VERIFY)
        json_url = json.loads(req_url.content)

        # BUILD MARKDOWN FOR WARROOM OUTPUT
        md = build_md(json_url, url)

        ec = {}
        ec['DBotScore'] = []
        url_ec = {'URL': url, 'SymantecDeepsight':{'Domain': json_url['host']['domain']}}
        dbotscore = 0
        known_behaviours = []
        known_ips = []

        # DETERMINE IF RISK IS KNOWN AND SET DBOTSCORE ACCORDINGLY
        url_behaviours = json_url.get('behaviours', None) if json_url.get('behaviours',None) else None
        if url_behaviours is not None:
            if len(url_behaviours) == 1 and url_behaviours[0]['behaviour'] == 'Spam':
                dbotscore = 2
                known_behaviours.append(url_behaviours[0]['behaviour'])
            elif len(url_behaviours) == 1 and url_behaviours[0]['behaviour'] != 'Spam':
                dbotscore = 3
                known_behaviours.append(url_behaviours[0]['behaviour'])
            else:
                for b in url_behaviours:
                    if b['behaviour'] == 'Spam' and dbotscore != 3:
                        dbotscore = 2
                    else:
                        dbotscore = 3
                    known_behaviours.append(b['behaviour'])

        ec['DBotScore'] = {'Indicator' : url, 'Score' : dbotscore, 'Type' : 'url', 'Vendor' : 'Symantec Deepsight Intelligence'}

        # COLLECT ADDITIONAL DATA
        ips = json_url.get('ips', None) if json_url.get('ips', None) else None
        if ips is not None:
            for ip_address in ips:
                known_ips.append(ip_address['ip'])
            url_ec[outputPaths['SymantecDeepsight']].update({'IPs': known_ips})

        if dbotscore == 3:
            # KNOWN MALICIOUS
            ec.update({
                outputPaths['URL']:{
                    'Data': url,
                    'Malicious': {
                        'Description': "URL is has known behaviour(s) of: " + ", ".join(known_behaviours),
                        'Vendor': 'Syamantec Deepsight Intelligence',
                        'Behaviours': known_behaviours
                    }
                }

            })
        else:
            ec.update({
                outputPaths['URL']: {
                    'Data': url
                }
            })
        if ec.get(outputPaths['URL'], False):
            ec[outputPaths['URL']['SymantecDeepsight']] = {}
            ec[outputPaths['URL']['SymantecDeepsight']] = {'Domain': json_url['host']['domain']}
            if len(known_ips) >=1:
                ec[outputPaths['URL']['SymantecDeepsight']].update({'IPs': known_ips})
        else:
            ec[outputPaths['url']].update(url_ec)

        # RETURN CONTEXTUAL INFORMATION
        return {
            'Type' : entryTypes['note'],
            'Contents' : json_url,
            'ContentsFormat' : formats['json'],
            'HumanReadable' : md, # not sure if need to build the md first?
            'ReadableContentsFormat' : formats['markdown'],
            'EntryContext' : ec
        }


    def login():
        login_do_response = requests.get(USAGE_URL, headers=headers, verify=VERIFY)
        login_status = login_do_response.status_code
        if login_status == requests.codes.ok:
            return True
        else:
            result = return_code_match(login_status)
            return result


    LOG('command is %s' % (demisto.command(), ))
    try:
        if demisto.command() == 'test-module':
            # Checks authentication and connectivity in login() function
            result = login()
            if result == True:
                demisto.results("ok")
            else:
                demisto.results("Test Failed" + str(result))
        elif demisto.command() == 'domain':
            demisto.results(request_domain_intel())
        elif demisto.command() == 'ip':
            demisto.results(request_ip_intel())
        elif demisto.command() == 'file':
            demisto.results(request_file_intel())
        elif demisto.command() == 'url':
            demisto.results(request_url_intel())
        elif demisto.command() == 'deepsight-get-request-status':
            demisto.results(request_status())
    except Exception, e:
        LOG(e)
        LOG.print_log()
        return_error(e.message)
  type: python
  commands:
  - name: domain
    arguments:
    - name: domain
      required: true
      default: true
      description: domain to be enriched.
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator value
      type: string
    - contextPath: DBotScore.Type
      description: The indicator's type
      type: string
    - contextPath: DBotScore.Vendor
      description: The indicator's vendor
      type: string
    - contextPath: DBotScore.Score
      description: The indicator's score
      type: number
    - contextPath: Domain.Name
      description: Domain Name
    - contextPath: Domain.Malicious.Vendor
      description: '"Symantec Deepsight Intelligence"'
    - contextPath: Domain.Malicious.Description
    - contextPath: Domain.SymantecDeepsight.AssociatedIPs
    - contextPath: Domain.SymantecDeepsight.AssociatedURLs
    - contextPath: Domain.Malicious.Reputation
    - contextPath: Domain.Malicious.Behaviours
    - contextPath: Domain.WhoIs
    description: Enrich a domain from Symantec Deepsight intelligence
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: IP to enrich
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator value
      type: string
    - contextPath: DBotScore.Type
      description: The indicator's type
      type: string
    - contextPath: DBotScore.Vendor
      description: The indicator's vendor
      type: string
    - contextPath: DBotScore.Score
      description: The indicator's score
      type: number
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.ASN
    - contextPath: IP.Carrier
    - contextPath: IP.Geo.Country
    - contextPath: IP.Malicious.Vendor
    - contextPath: IP.Malicious.Description
    - contextPath: IP.SymantecDeepsight.Whitelisted
    - contextPath: IP.SymantecDeepsight.FirstSeen
    - contextPath: IP.SymantecDeepsight.LastSeen
    - contextPath: IP.SymantecDeepsight.AssociatedURLs
      description: URLs associated with this IP
    - contextPath: IP.SymantecDeepsight.AssociatedDomains
      description: Domains associated with this IP
    - contextPath: IP.SymantecDeepsight.TargetCountries
      description: Targeted Countries involving this IP
    - contextPath: IP.SymantecDeepsight.TargetVectors
      description: Targeted Industry Vectors involving this IP
    description: Enrich an IP address from Symantec Deepsight Intelligence
  - name: file
    arguments:
    - name: hash
      required: true
      default: true
      description: sha256 or md5 hash only
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator value
      type: string
    - contextPath: DBotScore.Type
      description: The indicator's type
      type: string
    - contextPath: DBotScore.Vendor
      description: The indicator's vendor
      type: string
    - contextPath: DBotScore.Score
      description: The indicator's score
      type: number
    - contextPath: File.MD5
    - contextPath: File.SHA256
    - contextPath: File.Malicious.Vendor
    - contextPath: File.Malicious.Description
    - contextPath: File.SymantecDeepsight.Reputation
    - contextPath: File.SymantecDeepsight.DetectionName
    description: Enrich a file from Symantec Deepsight Intelligence
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: URL to enrich, Should contain HTTP(S)://
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator value
      type: string
    - contextPath: DBotScore.Type
      description: The indicator's type
      type: string
    - contextPath: DBotScore.Vendor
      description: The indicator's vendor
      type: string
    - contextPath: DBotScore.Score
      description: The indicator's score
      type: number
    - contextPath: URL.Data
    - contextPath: URL.Malicious.Vendor
    - contextPath: URL.Malicious.Description
    - contextPath: URL.SymantecDeepsight.Domain
      description: base domain of URL
    - contextPath: URL.SymantecDeepsight.IPs
      description: IP addresses associated with the URL
    - contextPath: URL.Malicious.Behaviours
      description: Known Behaviour of the URL
    description: Enrich an URL from Symantec Deepsight Intelligence
  - name: deepsight-get-request-status
    arguments: []
    description: Get API Usage status for current license period
  dockerimage: demisto/python:1.3-alpine
  runonce: false
